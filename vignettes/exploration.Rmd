---
title: "exploration"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{exploration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

```{r setup}
library(hottest100)
library(dplyr)
library(stringr)
library(forcats)
library(ggplot2)
library(ggrepel)
```

# Table overview

This package has three main tables.  Let's start by taking a quick look at each of them.

The first one is `artists`, an overview of each artist in the dataset.

```{r head-artists}

head(artists)

```

Next is `polls`, a list of each poll that has been run.  They are a mix of "songs of the year", and "best songs of all time" 

```{r head-polls}

head(polls)

```

Finally, the major table of the dataset is the `tracks` table, a list of all tracks which have appeared in any of the charts, along with information such as ranking and release year (since this does not always align with the year the poll ran).

```{r head-tracks}

head(tracks)

```

# Initial exploration

So, let's explore the data a bit.

First question: Do the same tracks appear in multiple polls?  (Answer: Yes, they do, because there are several "Best song of all time" polls in the collection!)

```{r count-of-song-appearances}

tracks %>%
  group_by(artist, track) %>%
  summarise(count = n()) %>%
  ungroup() %>% 
  arrange(-count)

```

Okay, *Throw Your Arms Around Me* appears the most.  Which years did it appear?

```{r throw-your-arms-appearances}

tracks %>%
  filter(track == 'Throw Your Arms Around Me' )

```
Huh, Paul McDermott's cover also got a mention!  What about other Hunters & Collectors songs?


```{r hunters-and-collectors-appearances}

tracks %>%
  filter(artist == 'Hunters & Collectors' ) %>%
  group_by(artist, track) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  arrange(-count)

```

Oh, the song `Talking to a Stranger` appears several different times with different capitalisation, and R is case sensitive, so it doesn't group them together.  This could be a problem.  

# Clean up capitalisation

Let's look at cleaning the field to make sure that doesn't cause problems.

```{r clean-data}

tracks_clean <- tracks %>%
  mutate(track_clean = str_to_title(track))

```

So, how many tracks are affected by these capitalisation issues?


```{r capitalisation-issue-tracks}

tracks_clean %>%
  group_by(artist, track, track_clean) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  group_by(artist, track_clean) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  filter(count > 1) %>%
  arrange(-count)

```

Now that we've fixed that, let's get back to the analysis.  

# Most popular artists

What about artists?  Which artists have the most songs in the list?

```{r most-popular-artists}

tracks_clean %>%
  group_by(artist) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  filter(count > 1) %>%
  slice_max(count, n = 20) %>%
  mutate(artist = fct_reorder(artist, count)) %>%
  ggplot(aes(x = count, y = artist)) +
  geom_col() +
  theme_bw()

```

Presumably a lot of those are the same popular songs repeated.  What about distinct tracks?

```{r popular-for-distinct-tracks}

tracks_clean %>%
  select(artist, track_clean) %>%
  distinct() %>%
  group_by(artist) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  filter(count > 1) %>%
  slice_max(count, n = 20) %>%
  mutate(artist = fct_reorder(artist, count)) %>%
  ggplot(aes(x = count, y = artist)) +
  geom_col() +
  theme_bw()

```

We could colour it by country, too.

```{r popular-for-distinct-tracks-colour-by-country}

tracks %>%
  mutate(track_clean = str_to_title(track)) %>%
  select(artist, track_clean, country) %>%
  distinct() %>%
  group_by(artist, country) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  filter(count > 1) %>%
  slice_max(count, n = 20) %>%
  mutate(artist = fct_reorder(artist, count)) %>%
  ggplot(aes(x = count, y = artist, fill = country)) +
  geom_col() +
  theme_bw()

```

What if we do only the "This year" polls, excluding the all times?

```{r popular-for-distinct-tracks-within-year}

tracks_clean %>%
  filter(!alltime) %>%
  select(artist, track_clean, country) %>%
  distinct() %>%
  group_by(artist, country) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  filter(count > 1) %>%
  slice_max(count, n = 20) %>%
  mutate(artist = fct_reorder(artist, count)) %>%
  ggplot(aes(x = count, y = artist, fill = country)) +
  geom_col() +
  theme_bw()


```

Billie Eilish manages to become a lot more prominent with that additional filter.

# Old timers and newbies

The artists that are appearing frequently are an interesting mix of old timers and newbies.  For the most common artists, have they had a long career, or did they rocket up the charts quickly? 

```{r hit-velocity}

tracks_clean %>%
  filter(!alltime )%>%
  semi_join(

    tracks_clean %>%
      filter(!alltime ) %>%
      group_by(artist) %>%
      summarise(count = n()) %>%
      ungroup() %>%
      slice_max(count, n = 10)
  ) %>%
  group_by(artist, pollyear) %>%
  summarise(hits = n()) %>%
  ungroup %>%
  arrange(artist, pollyear) %>%
  group_by(artist) %>%
  mutate(cumulative_hits = cumsum(hits)) %>%
  ungroup() %>%
  group_by(artist) %>%
  mutate(total_hits = sum(hits)) %>%
  mutate(artist_name = ifelse(total_hits == cumulative_hits, artist, NA_character_)) %>%
  mutate(artist_name_y = ifelse(total_hits == cumulative_hits, cumulative_hits + 1, NA_integer_)) %>%
  ungroup() %>%
  ggplot(aes(x = pollyear, y = cumulative_hits, group = artist, col = artist)) +
  geom_line() +
  geom_point() +
  geom_label_repel(aes(y = artist_name_y, label = artist_name)) +
  theme_bw() +
  theme(legend.position = 'none') +
  scale_x_continuous(limits = c(NA, 2030)) +
  labs(title = "Comparative velocity of most popular Triple J Hottest 100 artists over time",
       caption = "10 artists with the most songs across time in the 'this year' polls")

```

As might be expected, the older bands have had a lot more time to percolate, while artists like Billie Eilish and G Flip have had much more rapid increases over time.


```{r}


```
